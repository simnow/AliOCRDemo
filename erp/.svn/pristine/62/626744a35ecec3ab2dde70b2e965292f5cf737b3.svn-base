<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper
	namespace="cn.caecc.erp.modules.dao.ex.mapper.UserRoleRelationshipExMapper">
	<resultMap id="ExResultMap"
		type="cn.caecc.erp.modules.dao.ex.dto.UserDto">

		<id column="Id" jdbcType="INTEGER" property="id" />
		<result column="LoginName" jdbcType="VARCHAR"
			property="loginname" />
		<result column="Password" jdbcType="VARCHAR"
			property="password" />
		<result column="Name" jdbcType="VARCHAR" property="name" />
		<result column="DId" jdbcType="INTEGER" property="did" />
		<result column="UnitTelephone" jdbcType="VARCHAR"
			property="unittelephone" />
		<result column="Telephone" jdbcType="VARCHAR"
			property="telephone" />
		<result column="Landline" jdbcType="VARCHAR"
			property="landline" />
		<result column="NetworkCard" jdbcType="VARCHAR"
			property="networkcard" />
		<result column="Fax" jdbcType="VARCHAR" property="fax" />
		<result column="Email" jdbcType="VARCHAR" property="email" />
		<result column="Sex" jdbcType="INTEGER" property="sex" />
		<result column="IdNo" jdbcType="VARCHAR" property="idno" />
		<result column="JobNo" jdbcType="VARCHAR" property="jobno" />
		<result column="PositionId" jdbcType="INTEGER"
			property="positionid" />
		<result column="CreateTime" jdbcType="TIMESTAMP"
			property="createtime" />
		<result column="CreateUserId" jdbcType="INTEGER"
			property="createuserid" />
		<result column="UpdateTime" jdbcType="TIMESTAMP"
			property="updatetime" />
		<result column="UpdateUserId" jdbcType="INTEGER"
			property="updateuserid" />
		<result column="EmployTime" jdbcType="TIMESTAMP"
			property="employtime" />
		<result column="QuitTime" jdbcType="TIMESTAMP"
			property="quittime" />
		<result column="POId" jdbcType="INTEGER" property="poid" />
		<result column="HeadPortraitPath" jdbcType="VARCHAR"
			property="headportraitpath" />
		<result column="ElectronicSealPath" jdbcType="VARCHAR"
			property="electronicsealpath" />


		<result column="DName" property="dname" jdbcType="VARCHAR" />
		<result column="DCode" property="dcode" jdbcType="VARCHAR" />
		<collection property="roleList"
			ofType="cn.caecc.erp.modules.dao.mybatis.entity.Role">
			<id column="RId" property="id" jdbcType="INTEGER" />
			<result column="RName" property="name" jdbcType="VARCHAR" />
			<result column="CanModify" property="canmodify"
				jdbcType="INTEGER" />
			<result column="RDescription" property="description"
				jdbcType="VARCHAR" />
		</collection>
		<collection property="permissionList"
			ofType="cn.caecc.erp.modules.dao.mybatis.entity.Permission">
			<id column="PId" property="id" jdbcType="INTEGER" />
			<result column="PName" property="name" jdbcType="VARCHAR" />
			<result column="PDescription" property="description"
				jdbcType="VARCHAR" />
		</collection>
		<collection property="menuList"
			ofType="cn.caecc.erp.modules.dao.ex.dto.MenuDto">
			<id column="MenuId" jdbcType="INTEGER" property="menuid" />
			<result column="PMenuId" jdbcType="INTEGER" property="pmenuid" />
			<result column="MenuName" jdbcType="VARCHAR" property="name" />
			<result column="Action" jdbcType="VARCHAR" property="action" />
			<result column="Icon" jdbcType="VARCHAR" property="icon" />
			<result column="FunctionName" jdbcType="VARCHAR"
				property="functionname" />
			<result column="PMenuName" jdbcType="VARCHAR"
				property="pMenuName" />
			<result column="PAction" jdbcType="VARCHAR" property="pAction" />
			<result column="PIcon" jdbcType="VARCHAR" property="pIcon" />
		</collection>
	</resultMap>

	<resultMap id="BaseResultMap"
		type="cn.caecc.erp.modules.dao.mybatis.entity.UserRoleRelationshipKey">
		<!-- type="cn.caecc.erp.modules.dao.mybatis.entity.Role"> -->
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Mon Jul 09 
			16:20:59 CST 2018. -->
		<id column="Id" jdbcType="INTEGER" property="id" />
		<result column="RId" jdbcType="INTEGER" property="rid" />
		<!-- <result column="Name" jdbcType="VARCHAR" property="name" /> <result 
			column="Description" jdbcType="VARCHAR" property="description" /> <result 
			column="CanModify" jdbcType="INTEGER" property="canmodify" /> -->
	</resultMap>

	<select id="findUserRoleRelationshipByUserId"
		resultMap="ExResultMap" parameterType="java.lang.Integer">
		select
		u.*,
		d.Name DName,
		d.Code
		DCode,
		r.Id RId,
		r.Name RName,
		r.Description RDescription,
		r.CanModify
		CanModify,
		p.Id PRId,
		p.Name PName,
		p.Description PDescription,
		m1.MenuId
		MenuId,
		m1.PMenuId PMenuId,
		m1.Name MenuName,
		m1.Action Action,
		m1.Icon
		Icon,
		m1.FunctionName
		FunctionName,
		m2.Name PMenuName,
		m2.Action PAction,
		m2.Icon PIcon
		from
		user u
		left join
		department d
		on (u.DId=d.Id)
		left join
		user_role_relationship ur
		on (u.Id=ur.Id)
		left join role r
		on
		(ur.RId=r.Id)
		left join
		role_permission_relationship rp
		on (r.Id=rp.RId)
		left join permission p
		on (rp.PId=p.Id)
		left join menu m1
		on
		(p.MenuId=m1.MenuId)
		left join
		menu m2
		on (m1.PMenuId=m2.MenuId)
		where
		u.Id=#{id,jdbcType=INTEGER}
	</select>

	<insert id="batchAdd" parameterType="hashmap">
		INSERT INTO user_role_relationship(Id,Rid) VALUES
		<foreach collection="idlist" item="userid" index="index"
			separator=",">
			(#{userid},#{roleid})
		</foreach>
	</insert>

	<insert id="add"
		parameterType="cn.caecc.erp.modules.dao.mybatis.entity.UserRoleRelationshipKey">
		insert into user_role_relationship(Id,Rid)
		values(#{id},#{rid})
	</insert>



	<select id="findUserRoleByUserId" resultMap="BaseResultMap"
		parameterType="java.lang.Integer">
		select * from
		user_role_relationship
		where
		Id=#{id,jdbcType=INTEGER}
	</select>

	<!-- 删除数据，根据userid -->
	<delete id="deleteCanModifyUR" parameterType="Map">
		delete from user_role_relationship
		where Id =
		#{uId,jdbcType=INTEGER}
		and RId in
		<foreach item="RIdItem" collection="RIdList" open="("
			separator="," close=")">
			#{RIdItem}
		</foreach>
	</delete>

	<!-- 批量插入数据 -->
	<insert id="insertRoles">
		<selectKey keyProperty="id" order="AFTER"
			resultType="java.lang.Integer">
			SELECT LAST_INSERT_ID()
		</selectKey>
		insert into
		user_role_relationship(Id,RId)
		values
		<foreach collection="roles" item="role" separator=",">
			(#{role.id},
			#{role.rid}
			)
		</foreach>
	</insert>

</mapper>