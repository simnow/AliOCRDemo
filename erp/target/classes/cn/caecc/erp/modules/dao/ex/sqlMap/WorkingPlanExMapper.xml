<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="cn.caecc.erp.modules.dao.ex.mapper.WorkingPlanExMapper" >
  <resultMap id="BaseResultMap" type="cn.caecc.erp.modules.dao.ex.dto.WorkingPlanDto" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Mon Jul 30 09:17:36 CST 2018.
    -->
    <id column="WorkingPlanId" property="workingplanid" jdbcType="INTEGER" />
    <result column="UId" property="uid" jdbcType="INTEGER" />
    <result column="DId" property="did" jdbcType="INTEGER" />
    <result column="Week" property="week" jdbcType="TIMESTAMP" />
    <result column="Description" property="description" jdbcType="VARCHAR" />
    <result column="CreateUserId" property="createuserid" jdbcType="INTEGER" />
    <result column="CreateTime" property="createtime" jdbcType="TIMESTAMP" />
    <result column="UserName" property="username" jdbcType="VARCHAR" />
    <result column="DeptName" property="deptname" jdbcType="VARCHAR" />
    <result column="WeekNumber" property="weeknumber" jdbcType="INTEGER" />
  </resultMap>
  <select id="findByWeekAndDid" parameterType="cn.caecc.erp.modules.dao.mybatis.entity.WorkingPlan" resultType="cn.caecc.erp.modules.dao.mybatis.entity.WorkingPlan">
  
  	SELECT WP.* FROM working_plan WP
  	
	WHERE YEARWEEK(WP.`Week`,1)=YEARWEEK(#{week},1)
	
	AND  WP.Did=#{did}
	
  </select>
  <select id="findPlanByCondition" parameterType="hashmap" resultMap="BaseResultMap">
   				
	SELECT  WP.WorkingPlanId,WP.CreateTime,U.`Name` AS UserName,D.`Name` AS DeptName,WEEK(WP.`Week`,1) AS WeekNumber
 
	FROM working_plan WP

	LEFT JOIN `user` U

	ON(WP.UId=U.Id)

	LEFT JOIN department D

	ON(WP.DId=D.Id)
	
	<where>	
		<if test="did!=null and role==null">
			AND WP.DId=#{did}
		</if>	
		<if test="role!=null">
			AND FIND_IN_SET(WP.Did,getChildrenDept(#{did}))
		</if>
		<if test="nowsummary!=null">
			AND YEARWEEK(WP.`Week`,1)=YEARWEEK(NOW(),1)
		</if>	
		<if test="starttime!=null and endtime!=null">
			AND WP.`Week` BETWEEN  DATE_FORMAT(#{starttime},'%Y-%m-%d')   AND  #{endtime}
		</if>
		ORDER BY WP.`Week` 
	</where>
	</select>
  <select id="findDtoById" parameterType="int" resultMap="BaseResultMap">
  
  		
	SELECT  WP.*,U.`Name` AS UserName,D.`Name` AS DeptName,WEEK(WP.`Week`,1) AS WeekNumber

	FROM working_plan WP

	LEFT JOIN `user` U

	ON(WP.UId=U.Id)

	LEFT JOIN department D

	ON(WP.DId=D.Id)
	
	WHERE WP.WorkingPlanId=#{id}
  
  </select>
</mapper>